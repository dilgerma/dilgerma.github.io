{% assign maxRelated = 3 %}
{% assign minCommonTags = 1 %}
{% assign maxRelatedCounter = 0 %}

{% if page.tags %}
<section class="related-posts">
  <h2>Related Articles</h2>
  <div class="related-posts-grid">
    {% for post in site.docs %}
      {% if post.url != page.url and post.url contains '/blog/' and post.tags %}
        {% assign sameTagCount = 0 %}
        {% for tag in post.tags %}
          {% if page.tags contains tag %}
            {% assign sameTagCount = sameTagCount | plus: 1 %}
          {% endif %}
        {% endfor %}

        {% if sameTagCount >= minCommonTags %}
          {% if maxRelatedCounter < maxRelated %}
            <a href="{{ post.url | relative_url }}" class="related-post-card">
              {% if post.featured_image %}
              <div class="related-post-image">
                <img src="{{ post.featured_image | relative_url }}" alt="{{ post.title }}" loading="lazy">
              </div>
              {% endif %}
              <div class="related-post-content">
                <h3>{{ post.title }}</h3>
                {% if post.description %}
                <p>{{ post.description | truncate: 120 }}</p>
                {% endif %}
                <span class="related-post-meta">
                  {% if post.category %}{{ post.category }}{% endif %}
                  {% if post.date %} • {{ post.date | date: "%B %Y" }}{% endif %}
                </span>
              </div>
            </a>
            {% assign maxRelatedCounter = maxRelatedCounter | plus: 1 %}
          {% endif %}
        {% endif %}
      {% endif %}
    {% endfor %}
  </div>

  {% if maxRelatedCounter == 0 %}
  <div class="related-posts-grid">
    <a href="{{ '/docs/blog/event-modeling-adoption' | relative_url }}" class="related-post-card">
      <div class="related-post-content">
        <h3>Why Your Event Modeling Workshop Didn't Stick</h3>
        <p>Event Modeling doesn't fail in isolation. It fails at the breaks in your value chain.</p>
        <span class="related-post-meta">Event Modeling & Adoption • November 2025</span>
      </div>
    </a>
    <a href="{{ '/docs/blog/ai-event-modeling-enabler' | relative_url }}" class="related-post-card">
      <div class="related-post-content">
        <h3>How Event Modeling Became the Perfect AI Enabler</h3>
        <p>AI is the accelerant. Event Modeling is the structure that makes it work.</p>
        <span class="related-post-meta">AI & Event Modeling • November 2025</span>
      </div>
    </a>
    <a href="{{ '/docs/blog/state-based-systems-doomed-to-fail' | relative_url }}" class="related-post-card">
      <div class="related-post-content">
        <h3>State-Based Systems Are Doomed to Fail</h3>
        <p>Why adding features accelerates system decay and how understanding events changes everything.</p>
        <span class="related-post-meta">Architecture • November 2025</span>
      </div>
    </a>
  </div>
  {% endif %}
</section>
{% endif %}
